<script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script>
/**
 * Show an error message
 * @param  {String} error   the error text
 */
function showError(error) {
    $("div.error").text(error);
}

/**
 * Orders rows of desired extractions/unextractions table in ascending order by offset
 */
function orderRows(table) {
    var $rows   = $('tbody > tr', table);

    $rows.sort(function(a, b) {
        return ($(a).data('start') > $(b).data('start')) ? 1 : 0;
    });

    $rows.each(function(index, row){
      table.append(row);                  // append rows after sort
    });
}

/**
 * Updates "Start" button status, enabling it only if there is at least one
 * desired extraction and one desired unextractions and the other way around
 */
function updateButtonStatus() {
    if ($("#start").prop('disabled') &&
        $(".desired-extractions table > tbody > tr").length >= 1 &&
        $(".desired-unextractions table > tbody > tr").length >= 1) {
        $("#start").prop('disabled', false);
    }

    if (!$("#start").prop('disabled') &&
        !($(".desired-extractions table > tbody > tr").length >= 1 &&
        $(".desired-unextractions table > tbody > tr").length >= 1)) {
        $("#start").prop('disabled', true);
    }
}

/**
 * Adds a new annotation to the training set table
 * @param {TextRange} annotation   the new annotation
 * @param {String} type            type of the annotation (extr/unextr)
 */
function addAnnotationToTable(annotation, type) {
    var table = type === 'desired-extraction' ? $(".desired-extractions table") : $(".desired-unextractions table");

    // If it's the first annotation we add, delete the "empty" placeholder
    if (!$("tbody > tr", table).length) {
        $("span", table.parent()).hide();
    }

    table.append(
        "<tr data-start='" + annotation.startOffset + "' data-end='" + annotation.endOffset + "'>" +
        "<td class='annotation'>" + annotation.text + "</td>" +
        "<td class='button-cell'><a class='delete-annotation' href='#'><img src='https://openmerchantaccount.com/img2/close_1.png' width='24' height='22' alt='remove item' border='0'></a></td></tr>"
    );

    orderRows(table);

    updateButtonStatus();
}

$(function(){
    // Load previously saved annotations
    google.script.run
        .withSuccessHandler(function (annotations) {
            var desiredExtractions   = annotations[0],
                desiredUnextractions = annotations[1];

            if (desiredExtractions !== null) {
                for (var i = 0; i < desiredExtractions.length; i++) {
                    addAnnotationToTable(desiredExtractions[i], 'desired-extraction');
                }
            }
            if (desiredUnextractions !== null) {
                for (var j = 0; j < desiredUnextractions.length; j++) {
                    addAnnotationToTable(desiredUnextractions[j], 'desired-unextraction');
                }
            }
        })
        .getSavedAnnotations();

    // Add selection as desired extraction / unextraction
    $('.add-selection').click(function () {
        var button = $(this);
        google.script.run
            .withSuccessHandler(function (annotation) {
                // Reset error message
                $('div.error').empty();

                addAnnotationToTable(annotation, button.data('type'));
            })
            .withFailureHandler(showError)
            .addSelectionAsAnnotation(button.data('type'));

        return false;
    });

    // Open highlight colors editor modal
    $('#edit-colors').click(function () {
        google.script.run.showColorsModal();

        return false;
    });

    // Highlight enabling / disabling
    $("#use-highlight").change(function () {
        if (!this.checked) {
            google.script.run.resetBackground();
        } else {
            google.script.run.reDrawHighlights();
        }
    });

    // Run the extractor
    $("button#start").click(function() {
        google.script.run
            .withFailureHandler(showError)
            .withSuccessHandler(function(query){
                $("div.query").append('Query: ' + JSON.stringify(query, null, 2));
            })
            .runExtractor();
    });

    // Reset addon status
    $("button#reset").click(function() {
        google.script.run
            .withFailureHandler(showError)
            .withSuccessHandler(function(){
                $(".training-set table > tbody > tr").each(function() {
                    $(this).remove();
                });

                $(".training-set span").show();
                $("div.error").empty();
                $("div.query").empty();
                $("#start").prop('disabled', true);
            })
            .resetEverything();
    });

    // Export system extractions to new document
    $("button#export").click(function() {
        google.script.run
            .withFailureHandler(showError)
            .exportExtractions();
    });

    // Select annotation on click
    $(document).on('click', 'td.annotation', function () {
        var $row        = $(this).parent(),
            startOffset = $row.data('start'),
            endOffset   = $row.data('end');

        google.script.run.selectAnnotation(startOffset, endOffset);
    });

    // Annotation deletion
    $(document).on('click', 'a.delete-annotation', function () {
        var $anchor = $(this);
        var $row = $anchor.parent().parent();
        var startOffset = $row.data('start');

        google.script.run
            .withSuccessHandler(function() {
                // If this was the last row to be removed, show the placeholder
                if (!$row.siblings().size()) $("span", $row.parent().parent().parent()).show();

                $row.remove();

                updateButtonStatus();

            })
            .withFailureHandler(showError)
            .deleteAnnotation(startOffset);

        return false;
    });
});
</script>
